name: binaries

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  linux-bin:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: awalsh128/cache-apt-pkgs-action@v1
      with:
        packages: binaryen \
          libwebkit2gtk-4.1-dev \
          libgtk-3-dev \
          libayatana-appindicator3-dev

    - uses: dtolnay/rust-toolchain@stable
    - uses: Swatinem/rust-cache@v2

    - name: Download dependencies
      run: |
        cargo install --git https://github.com/DioxusLabs/dioxus dioxus-cli

    - name: Build artifacts
      run: |
        cargo build -p ncsu_exam_calendar_cli --release
        mv target/release/ncsu_exam_calendar_cli x86_64-linux-ncsu_examc
        dx bundle --bin ncsu_exam_calendar_desktop --release

    - uses: actions/actions/upload-artifact@v3
      with: 
        name: x86_64-linux-ncsu_examc ${{ matrix.node-version }}
        path: |
          x86_64-linux-ncsu_examc
          desktop/dist/bundle/deb/*.deb
          desktop/dist/bundle/appimage/*.AppImage,
        retention-days: 1

  mac-x86-bin:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - uses: dtolnay/rust-toolchain@stable
    - uses: Swatinem/rust-cache@v2

    - name: Download dependencies
      run: |
        brew install binaryen
        cargo install --git https://github.com/DioxusLabs/dioxus dioxus-cli

    - name: Build artifacts
      run: |
        cargo build -p ncsu_exam_calendar_cli --release
        mv target/release/ncsu_exam_calendar_cli x86_64-mac-ncsu_examc
        dx bundle --bin ncsu_exam_calendar_desktop --release

    - uses: actions/actions/upload-artifact@v3
      with: 
        name: x86_64-mac-ncsu_examc ${{ matrix.node-version }}
        path: |
          x86_64-mac-ncsu_examc
          desktop/dist/bundle/macos/*.app
          desktop/dist/bundle/dmg/*.dmg
        retention-days: 1

  windows-bin:
    if: false
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - uses: dtolnay/rust-toolchain@stable
    - uses: Swatinem/rust-cache@v2

    - name: Download dependencies
      run: |
        choco install binaryen sed
        cargo install --git https://github.com/DioxusLabs/dioxus dioxus-cli
        sed -i 's;/;\\;g' desktop/Cargo.toml # Filesystem paths...

    - name: Build artifacts
      run: |
        cargo build -p ncsu_exam_calendar_cli --release
        move target\release\ncsu_exam_calendar_cli target\release\x86-windows-ncsu_examc
        dx bundle --bin ncsu_exam_calendar_desktop --release

    - run: ls desktop/dist/bundle/*
    - run: ls target/release/
