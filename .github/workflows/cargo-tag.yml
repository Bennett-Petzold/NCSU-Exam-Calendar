name: cargo-tag

on:
  push:

jobs:
  update-tag:
    runs-on: ubuntu-latest
    if: ${{ ! startsWith(github.ref, 'refs/tags/') }}

    steps:
    - uses: actions/checkout@v4

    - uses: awalsh128/cache-apt-pkgs-action@v1
      with:
        packages: jq

    - uses: dtolnay/rust-toolchain@stable

    - name: Update tag with cargo toml
      run: |
        VERSION="$(cargo metadata --format-version 1 | jq '.packages.[] | select(.name == "ncsu_cal_lib")| .version' | tr -d '"')"
        echo "$VERSION"
        git tag -m '' -a v"$VERSION"
